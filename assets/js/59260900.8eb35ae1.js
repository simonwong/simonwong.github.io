"use strict";(self.webpackChunknote=self.webpackChunknote||[]).push([[5533],{9613:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return m}});var r=t(9496);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function c(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function a(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=r.createContext({}),s=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):c(c({},n),e)),t},u=function(e){var n=s(e.components);return r.createElement(l.Provider,{value:n},e.children)},f={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,u=a(e,["components","mdxType","originalType","parentName"]),d=s(t),m=o,p=d["".concat(l,".").concat(m)]||d[m]||f[m]||i;return t?r.createElement(p,c(c({ref:n},u),{},{components:t})):r.createElement(p,c({ref:n},u))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,c=new Array(i);c[0]=d;var a={};for(var l in n)hasOwnProperty.call(n,l)&&(a[l]=n[l]);a.originalType=e,a.mdxType="string"==typeof e?e:o,c[1]=a;for(var s=2;s<i;s++)c[s]=t[s];return r.createElement.apply(null,c)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},3472:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return a},contentTitle:function(){return l},metadata:function(){return s},toc:function(){return u},default:function(){return d}});var r=t(5900),o=t(4750),i=(t(9496),t(9613)),c=["components"],a={},l="React \u6d41\u7a0b\u4f2a\u7801",s={unversionedId:"advanced/react-deep/react-fake",id:"advanced/react-deep/react-fake",title:"React \u6d41\u7a0b\u4f2a\u7801",description:"React \u6d41\u7a0b\u4f2a\u7801\uff0c\u5217\u51fa\u6765 React \u5404\u4e2a\u8fc7\u7a0b\u4e2d\u7684\u4e3b\u8981\u51fd\u6570\uff0c\u53ca\u5176\u5185\u90e8\u7b80\u7565\u63cf\u8ff0",source:"@site/docs/advanced/react-deep/react-fake.md",sourceDirName:"advanced/react-deep",slug:"/advanced/react-deep/react-fake",permalink:"/docs/advanced/react-deep/react-fake",tags:[],version:"current",frontMatter:{},sidebar:"advanced",previous:{title:"commit \u9636\u6bb5",permalink:"/docs/advanced/react-deep/stage-commit"},next:{title:"lane \u6a21\u578b",permalink:"/docs/advanced/react-deep/lane-model"}},u=[{value:"render \u9636\u6bb5\u7684\u5165\u53e3",id:"render-\u9636\u6bb5\u7684\u5165\u53e3",children:[{value:"ReactDOM.render()",id:"reactdomrender",children:[],level:3},{value:"useState",id:"usestate",children:[],level:3}],level:2},{value:"render \u9636\u6bb5",id:"render-\u9636\u6bb5",children:[{value:"performUnitOfWork",id:"performunitofwork",children:[],level:3},{value:"beginWork",id:"beginwork",children:[],level:3},{value:"completeWork",id:"completework",children:[],level:3}],level:2},{value:"commit \u9636\u6bb5",id:"commit-\u9636\u6bb5",children:[{value:"beforeMuatation",id:"beforemuatation",children:[],level:3},{value:"mutation",id:"mutation",children:[],level:3},{value:"layout",id:"layout",children:[],level:3}],level:2}],f={toc:u};function d(e){var n=e.components,t=(0,o.Z)(e,c);return(0,i.kt)("wrapper",(0,r.Z)({},f,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"react-\u6d41\u7a0b\u4f2a\u7801"},"React \u6d41\u7a0b\u4f2a\u7801"),(0,i.kt)("p",null,"React \u6d41\u7a0b\u4f2a\u7801\uff0c\u5217\u51fa\u6765 React \u5404\u4e2a\u8fc7\u7a0b\u4e2d\u7684\u4e3b\u8981\u51fd\u6570\uff0c\u53ca\u5176\u5185\u90e8\u7b80\u7565\u63cf\u8ff0"),(0,i.kt)("p",null,"\u6ce8\u91ca\u542b\u4e49\uff1a"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"// xxx ...")," \u8868\u793a xxx \u5185\u5bb9\u7701\u7565\u4e86"),(0,i.kt)("h2",{id:"render-\u9636\u6bb5\u7684\u5165\u53e3"},"render \u9636\u6bb5\u7684\u5165\u53e3"),(0,i.kt)("p",null," \u8fdb\u5165 render \u9636\u6bb5\u6709\u5f88\u591a\u79cd\u65b9\u5f0f\uff0c\u4f46\u6700\u7ec8\u90fd\u4f1a\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"performSyncWorkOnRoot")," \u6216 ",(0,i.kt)("inlineCode",{parentName:"p"},"performConcurrentWorkOnRoot")," \u65b9\u6cd5\u8fdb\u5165\u3002"),(0,i.kt)("p",null,"\u7ec4\u4ef6\u5206\u7c7b"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ReactDOM.render "),"\u2014\u2014 HostRoot"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"this.setState")," \u2014\u2014 ClassComponent"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"this.forceUpdate")," \u2014\u2014 ClassComponent"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"useState")," \u2014\u2014 FunctionComponent"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"useReducer")," \u2014\u2014 FunctionComponent")),(0,i.kt)("p",null,"\u4e00\u5171\u4e09\u79cd\u7ec4\u4ef6\uff08",(0,i.kt)("inlineCode",{parentName:"p"},"HostRoot")," | ",(0,i.kt)("inlineCode",{parentName:"p"},"ClassComponent")," | ",(0,i.kt)("inlineCode",{parentName:"p"},"FunctionComponent"),"\uff09\u53ef\u4ee5\u89e6\u53d1\u66f4\u65b0\u3002"),(0,i.kt)("h3",{id:"reactdomrender"},"ReactDOM.render()"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function render () {\n  // \u521b\u5efa FiberRoot ...\n  updateContainer()\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function updateContainer () {\n  performSyncWorkOnRoot()\n}\n")),(0,i.kt)("h3",{id:"usestate"},"useState"),(0,i.kt)("p",null,"dispatch"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function scheduleUpdateOnFiber (fiber, lane) {\n  const root = markUpdateLaneFromFiberToRoot(fiber, lane);\n  // ...\n  \n  ensureRootIsScheduled(root, eventTime)\n  return root;\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// \u4ece\u4e0b\u5f80\u4e0a\u5bfb\u627e RootFiber\n// \u6807\u8bb0\u4ece Fiber \u5230 Root \u7684 \u66f4\u65b0\u4f18\u5148\u7ea7\nfunction markUpdateLaneFromFiberToRoot (sourceFiber\uff0c lane) {\n  let node = sourceFiber\n  let parent = sourceFiber.return\n  while (parent !== null) {\n    // parent.childLanes = mergelane(parent.childLanes, lane) ... \n    // alternate.childLanes = mergeLanes(alternate.childLanes, lane) ...\n    node = parent\n    parent = parent.return\n  }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// \u4f7f\u7528\u8be5\u65b9\u6cd5\u4e3a root \u8c03\u5ea6\u4e00\u4e2a\u4efb\u52a1\u3002\u6bcf\u4e2a root \u53ea\u6709\u4e00\u4e2a\u4efb\u52a1\u3002\n// \u5982\u679c\u5df2\u7ecf\u5b89\u6392\u4e86\u4efb\u52a1\uff0c\u6211\u4eec\u5c06\u8fdb\u884c\u68c0\u67e5\uff0c\u4ee5\u786e\u4fdd\u73b0\u6709\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\u4e0e root \u6240\u5904\u7406\u7684\u4e0b\u4e00\u7ea7\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\u76f8\u540c\n// \u5728\u6bcf\u6b21\u66f4\u65b0\u65f6\uff0c\u4ee5\u53ca\u5728\u9000\u51fa\u4efb\u52a1\u4e4b\u524d\uff0c\u90fd\u4f1a\u8c03\u7528\u6b64\u51fd\u6570\u3002\nfunction ensureRootIsScheduled () {\n  // \u4efb\u52a1\u5f00\u59cb\u524d\u68c0\u67e5 ...\n  \n  if (newCallbackPriority === SyncLane) {\n    if (root.tag === LegacyRoot) {\n      scheduleLegacySyncCallback(performSyncWorkOnRoot.bind(null, root))\n    } else {\n      scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root))\n    }\n    \n    // \u5728 Microtasks \u4e2d\u5237\u65b0\u961f\u5217\uff08\u6216\u8005Immediate task\uff09\n  } else {\n    scheduleCallback(\n      schedulerPriorityLevel,\n      performConcurrentWorkOnRoot.bind(null, root),\n    )\n  }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function scheduleSyncCallback(callback) {\n  // \u662f\u76f4\u63a5push \u7684\n  syncQueue.push(callback)\n}\n\nfunction scheduleCallback (callback, deprecated_options) {\n  // ...\n  // \u5c06\u65b0\u56de\u8c03\u63d2\u5165\u5217\u8868\uff0c\u5148\u6309\u8fc7\u671f\u65f6\u95f4\u6392\u5e8f\uff0c\u7136\u540e\u6309\u63d2\u5165\u987a\u5e8f\u6392\u5e8f\u3002\n  // \u56e0\u6b64\uff0cnew callback \u88ab\u63d2\u5165\u5230\u4efb\u4f55\u76f8\u540c\u8fc7\u671f\u65f6\u95f4\u7684\u56de\u8c03\u4e2d\u3002\n}\n")),(0,i.kt)("h2",{id:"render-\u9636\u6bb5"},"render \u9636\u6bb5"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'// \u6240\u6709\u5e76\u53d1\u4efb\u52a1\u7684\u5165\u53e3\nfunction performConcurrentWorkOnRoot () {\n  // \u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u4f1a\u7981\u7528\u65f6\u95f4\u5207\u7247\uff1a\n  // \u5982\u679c\u5de5\u4f5c\u88abCPU\u7ed1\u5b9a\u7684\u65f6\u95f4\u592a\u957f\uff08"expired" work, \u6765\u9632\u6b62 starvation\uff09\uff0c\n  // \u6216\u8005\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6211\u4eec\u5904\u4e8e\u540c\u6b65\u66f4\u65b0\u6a21\u5f0f\u3002\n  shouldTimeSlice(root, lanes) && (disableSchedulerTimeoutInWorkLoop || !didTimeout)\n    ? renderRootConcurrent(root, lanes)\n    : renderRootSync(root, lanes)\n  \n  // ...\n}\n\n// \u8fd9\u662f\u4e0d\u7ecf\u8fc7\u8c03\u5ea6\u7a0b\u5e8f\u7684\u540c\u6b65\u4efb\u52a1\u7684\u5165\u53e3\nfunction performSyncWorkOnRoot () {\n  // ...\n  renderRootSync()\n  // ...\n}\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function renderRootSync () {\n  while (workInProgress == null) {\n    performUnitOfWork(workInProgress)\n  }\n}\n\nfunction renderRootConcurrent () {\n  while (workInProgress == null && !shouldYeild()) {\n    performUnitOfWork(workInProgress)\n  }\n}\n")),(0,i.kt)("h3",{id:"performunitofwork"},"performUnitOfWork"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// \u6267\u884c\u5728\u4e0a\u9762\u7684 while \u5faa\u73af\u4e2d\nfunction performUnitOfWork (workInProgress) {\n  const current = workInProgress.altnate\n  const next = beginWork(current, workInProgress);\n  \n  if (next) {\n    workInProgress = next\n  } else {\n    completeUnitOfWork()\n  }\n}\n\nfunction completeUnitOfWork (completedWork) {\n  do {\n    const current = completedWork.alternate\n    const next = completeWork(current, completedWork)\n    \n    // completeWork \u662f\u5728\u9012\u5f52\u7684\u5f52\u9636\u6bb5\uff0c\u4ece\u4e0b\u5f80\u4e0a\u7684\n    completedWork = next || completedWork.sibling || completedWork.return  // fake\n  } while (completedWork !== null)\n}\n")),(0,i.kt)("h3",{id:"beginwork"},"beginWork"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function beginWork (current, workInProgress) {\n  // \u8868\u793a\u66f4\u65b0\uff08\u4e0d\u662f\u9996\u6b21\u6302\u8f7d\uff09\n  if (current !== null) {\n    // oldProps \u4e0e newProps \u7684\u6bd4\u8f83\n    if (current.memoizedProps !== workInProgress.pendingProps) {\n      didReceiveUpdate = true\n      \n    } else if (!includesSomeLane(renderLanes, updateLanes)) {\n      // \u8868\u793a\u5f53\u524d fiber \u6ca1\u6709 pending work\uff0c\n      didReceiveUpdate = false\n      // \u505a\u4e00\u4e9b bookkeeping \u7684\u5de5\u4f5c\uff0c\u4e3b\u8981\u662f\u63a8\u5230\u5806\u6808\u4e0a\u53bb\n      // bailoutOnAlreadyFinishedWork() ...\n    } else {\n      // \u8ba1\u5212\u5bf9\u8be5fiber\u8fdb\u884c\u66f4\u65b0\uff0c\u5148\u8bbe\u4e3a flase\n      // \u5982\u679c\u6709 update queue \u6216 context consumer \u66f4\u6539\u503c\uff0c\u5219\u4f1a\u8bbe\u4e3a true\u3002\n      // \u5426\u5219\u5c31\u5047\u5b9a children \u90fd\u6ca1\u6709\u66f4\u6539\uff0c\u5e76\u9000\u51fa\n      didReceiveUpdate = false\n    }\n  } else {\n    didReceiveUpdate = false\n  }\n  // \u5728\u8fdb\u5165 begin \u9636\u6bb5\u4e4b\u524d\uff0c\u6e05\u9664\u6302\u8d77\u7684\u66f4\u65b0\u4f18\u5148\u7ea7\u3002\n  workInProgress.lanes = NoLanes\n  // \u6b63\u5f0f\u8fdb\u5165 begin \u9636\u6bb5\n  \n  switch (workInProgress.tag) {\n    // case ...\n    case FunctionComponent: {\n      // return updateFunctionComponent() ...\n    }\n      \n    case HostComponent: {\n      return updateHostComponent(current, workInProgress, renderLanes)\n    }\n      \n    // case ...\n  }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function updateHostComponent (current, workInProgress, renderLanes) {\n    // nextChildren = workInProgress.pendingProps.children\n  reconcileChildren(current, workInProgress, nextChildren, renderLanes);\n  return workInProgress.child\n}\n\nfunction reconcileChildren () {\n  if (current === null) {\n    // \u5982\u679c\u662f\u5c1a\u672a\u6e32\u67d3\u7684\u65b0\u7ec4\u4ef6\uff0c\u6211\u4eec\u4e0d\u4f1a\u901a\u8fc7\u5e94\u7528 minimal side-effects \u6765\u66f4\u65b0 child\n    // \u6211\u4eec\u5c06\u5728\u6e32\u67d3\u94b1\u5c06\u4ed6\u4eec\u5168\u90e8\u6dfb\u52a0\u5230 child \uff0c\u610f\u5473\u7740\u6211\u4eec\u4e0d\u9700\u8981\u8ddf\u8e2a side-effects\n    workInProgress.child = mountChildFibers(\n      workInProgress,\n      null,\n      nextChildren,\n      renderLanes,\n    )\n  } else {\n    // \u8fdb\u5165 diff \u7b97\u6cd5\n    workInProgress.child = reconcileChildFibers(\n      workInProgress,\n      current.child,\n      nextChildren,\n      renderLanes,\n    );\n  }\n}\n// \u533a\u522b\u5728\u4e8e\u662f\u5426\u8ddf\u8e2a\u526f\u4f5c\u7528\u3002\u5b9e\u9645\u4e0a\u90fd\u662f\u8fdb\u5165 ChildReconciler \u4e2d\u7684 reconcileChildFibers \u65b9\u6cd5\nconst reconcileChildFibers = ChildReconciler(true);\nconst mountChildFibers = ChildReconciler(false);\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"diff \u7b97\u6cd5 reconcileChildFibers")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function ChildReconciler (shouldTrackSideEffects) {\n  // function deleteChild ...\n  // function deleteRemainingChildren ...\n  // function ...\n  \n  function placeSingleChild () {}\n  \n  function reconcileSingleElement () {}\n\n  function reconcileChildrenArray () {}\n  \n  // \u6700\u7ec8\u901a\u8fc7 diff \u7b97\u6cd5\u8fd4\u56de\u65b0\u7684\uff08\u4e5f\u53ef\u80fd\u662f\u590d\u7528\u7684\uff09 fiber \u5bf9\u8c61\n  function reconcileChildFibers (returnFiber, currentFirstChild, newChild, lanes) {\n    if (typeof newChild === 'object' && newChild !== null) {\n      switch (newChild.$$typeof) {\n        case REACT_ELEMENT_TYPE: {\n          return placeSingleChild(\n            reconcileSingleElement(returnFiber, currentFirstChild, newChild, lanes),\n          )\n        }\n          // case REACT_PORTAL_TYPE REACT_LAZY_TYPE ...\n      }\n      \n      if (isArray(newChild)) {\n        return reconcileChildrenArray(returnFiber, currentFirstChild, newChild, lanes)\n      }\n    }\n    \n    if (typeof newChild === 'string' || typeof newChild === 'number') {\n      return placeSingleChild(\n        reconcileSingleTextNode(returnFiber, currentFirstChild, '' + newChild, lanes),\n      );\n    }\n  }\n  return reconcileChildFibers\n}\n")),(0,i.kt)("h3",{id:"completework"},"completeWork"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function completeWork (current\uff0c workInProgress) {\n  swutch (workInProgress.tag) {\n    case FunctionComponent:\n    // case ...\n        return null\n    // case\n    case HostComponent: {\n      // \u521b\u5efa\u771f\u5b9e\u8282\u70b9\n            const instance = createInstance()\n      // \u5c06 workInProgress \u7684\u6240\u6709\u5b50\u8282\u70b9\u7684\u771f\u5b9e\u8282\u70b9\u90fd apend \u5230 instanse \u4e0a\n            appendAllChildren(instance, workInProgress, false, false);\n      return null\n    }\n        \n  }\n}\n")),(0,i.kt)("h2",{id:"commit-\u9636\u6bb5"},"commit \u9636\u6bb5"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// commitRootImpl\nfunction commitRoot(root) {\n  do {\n    // `flushPassiveEffects'\u6700\u540e\u5c06\u8c03\u7528'flushSyncUpdateQueue'\uff0c\n    // \u8fd9\u610f\u5473\u7740'flushPassiveEffects'\u6709\u65f6\u4f1a\u5bfc\u81f4\u989d\u5916\u7684 passive effects\uff0c\n    // \u56e0\u6b64\uff0c\u6211\u4eec\u9700\u8981\u5728\u5faa\u73af\u4e2d\u4e0d\u65ad\u5237\u65b0\uff0c\u76f4\u5230\u4e0d\u518d\u6709 pendding effects\n    flushPassiveEffects();\n  } while (rootWithPendingPassiveEffects !== null);\n\n  const finishedWork = root.finishedWork;\n  const lanes = root.finishedLanes;\n  \n  \n  /**\n    * commit \u9636\u6bb5\u7684\u5165\u53e3\u662f `commitRoot` \u65b9\u6cd5\uff08`commitRootImpl`\uff09\uff0c\n    * commit \u9636\u6bb5\u5206\u4e3a\u4e09\u4e2a\u5b50\u9636\u6bb5\uff0c\u4e3a\u6bcf\u4e2a\u9636\u6bb5\u5355\u72ec\u4f20\u9012 effect list\uff1a\n    * \u6240\u6709\u7684 mutation effects \u90fd\u6bd4\u6240\u6709\u7684 layout effects \u5148\u6765\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002\n    */\n  /**\n    * \u7b2c\u4e00\u4e2a\u9636\u6bb5\u662f before mutation \u9636\u6bb5\uff0c\u5728umtate host tree \u4e4b\u524d\uff0c\n    * \u6211\u4eec\u8bfb\u53d6 host tree \u7684\u72b6\u6001\uff0c\u8fd9\u91cc\u662f\u8c03\u7528 `getSnapshotBeforeUpdate` \u7684\u5730\u65b9\u3002\n    */\n  const shouldFireAfterActiveInstanceBlur = commitBeforeMutationEffects(\n    root,\n    finishedWork,\n  );\n  \n  // \u4e0b\u4e00\u4e2a\u9636\u6bb5\u662f mutation phase, \u6211\u4eec\u5c06\u6302\u8f7d host tree\n  commitMutationEffects(root, finishedWork, lanes);\n  \n  // \u4e0b\u4e00\u4e2a\u9636\u6bb5\u662f\u5e03\u5c40\u9636\u6bb5\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u5728 \u6302\u8f7d host tree \u540e\u8bfb hst tree effects\n  // \u8fd9\u65b9\u9762\u7684\u60ef\u7528\u7528\u4f8b\u662f\u5e03\u5c40\uff0c\u4f46\u7531\u4e8e\u9057\u7559\u539f\u56e0\uff0c\u7c7b\u7ec4\u4ef6\u751f\u547d\u5468\u671f\u4e5f\u5728\u8fd9\u91cc\u89e6\u53d1\u3002\n  commitLayoutEffects(finishedWork, root, lanes);\n}\n")),(0,i.kt)("h3",{id:"beforemuatation"},"beforeMuatation"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function commitBeforeMutationEffects (root, firstChild) {\n  nextEffect = firstChild\n  commitBeforeMutationEffects_begin()\n}\n\nfunction commitBeforeMutationEffects_begin () {\n  while (nextEffect !== null) {\n    const deletions = fiber.deletions;\n    // for of\n    // commitBeforeMutationEffectsDeletion(deletion) ... \u5904\u7406 deletions\n    \n    const child = fiber.child;\n    if (\n      (fiber.subtreeFlags & BeforeMutationMask) !== NoFlags &&\n      child !== null\n    ) {\n      ensureCorrectReturnPointer(child, fiber);\n      nextEffect = child;\n    } else {\n      commitBeforeMutationEffects_complete();\n    }\n  }\n}\n\n\nfunction commitBeforeMutationEffects_complete () {\n  while (nextEffect !== null) {\n    commitBeforeMutationEffectsOnFiber(nextEffect)\n    nextEffect = nextEffect.sibling || nextEffect.return // fake\n  }\n}\n\nfunction commitBeforeMutationEffectsOnFiber (finishedWork) {\n  // \u5904\u7406\u4e00\u4e9b\u5931\u7126\u903b\u8f91\uff1f\n}\n")),(0,i.kt)("h3",{id:"mutation"},"mutation"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function commitMutationEffects (root, firstChild) {\n  nextEffect = firstChild\n  commitMutationEffects_begin(root)\n}\n\nfunction commitBeforeMutationEffects_begin (root) {\n  while (nextEffect !== null) {\n    const deletions = fiber.deletions;\n    // for of\n    // commitBeforeMutationEffectsDeletion(deletion) ... \u5904\u7406 deletions\n    \n    const child = fiber.child;\n    if (\n      (fiber.subtreeFlags & MutationMask) !== NoFlags &&\n      child !== null\n    ) {\n      ensureCorrectReturnPointer(child, fiber);\n      nextEffect = child;\n    } else {\n      commitMutationEffects_complete(root);\n    }\n  }\n}\n\n\nfunction commitMutationEffects_complete (root) {\n  while (nextEffect !== null) {\n    commitMutationEffectsOnFiber(nextEffect, root)\n    nextEffect = nextEffect.sibling || nextEffect.return // fake\n  }\n}\n\nfunction commitBeforeMutationEffectsOnFiber (finishedWork) {\n  // ContentReset && commitResetTextContent ...\n  // Ref && commitAttachRef ...\n  // Visibility ...\n  \n  // \u5904\u7406 placement \u3001updates\u3001deletions\n  \n  switch (flags & (Placement | Update | Hydrating)) {\n    case: Placement {\n      // Placement\n      commitPlacement(finishedWork)\n      break\n    }\n    case: PlacementAndUpdate {\n        // Placement\n      commitPlacement(finishedWork)\n      \n      // Update\n      const current = finishedWork.alternate;\n      commitWork(current, finishedWork);\n        break\n    }\n        /// case: ...\n    case: Update {\n      const current = finishedWork.alternate;\n      commitWork(current, finishedWork);\n            break\n    }\n  }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function commitPlacement(finishedWork) {\n  // ...\n  // \u6211\u4eec\u53ea\u6709\u63d2\u5165\u7684\u9876\u5c42\u5149\u7ea4\uff0c\u4f46\u6211\u4eec\u9700\u8981\u5411\u4e0b\u9012\u5f52\u5b83\u7684\u5b50\u8282\u70b9\uff0c\u4ee5\u627e\u5230\u6240\u6709\u7684\u7ec8\u7aef\u8282\u70b9\u3002\n  if (isContainer) {\n    insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);\n  } else {\n    insertOrAppendPlacementNode(finishedWork, before, parent);\n  }\n}\n\nfunction commitWork(current, finishedWork) {\n  \n}\n")),(0,i.kt)("h3",{id:"layout"},"layout"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function commitLayoutEffects (finishedWork, root) {\n  nextEffect = finishedWork\n  commitLayoutEffects_begin()\n}\n\nfunction commitBeforeMutationEffects_begin () {\n  while (nextEffect !== null) {\n    const deletions = fiber.deletions;\n    // \u5904\u7406\u5404\u79cd\u60c5\u51b5\uff0c\u5982 The Offscreen tree is hidden. Skip over its layout effects.\n    \n    const child = fiber.child;\n    if ((fiber.subtreeFlags & LayoutMask) !== NoFlags && child !== null) {\n      ensureCorrectReturnPointer(child, fiber);\n      nextEffect = child;\n    } else {\n      commitLayoutMountEffects_complete();\n    }\n  }\n}\n\n\nfunction commitLayoutMountEffects_complete () {\n  while (nextEffect !== null) {\n    commitLayoutEffectOnFiber(root, current, fiber, committedLanes)\n    nextEffect = nextEffect.sibling || nextEffect.return // fake\n  }\n}\n\nfunction commitLayoutEffectOnFiber (finishedWork) {\n  if \uff08finishedWork.flags === LayoutMask\uff09 {\n    switch (finishedWork.tag) {\n      // case ...\n      case FunctionComponent: {\n        // commitHookEffectListMount ...\n        }\n      case ClassComponent: {\n        // \u5904\u7406\u4e00\u4e9b\u7c7b\u7ec4\u4ef6\u7684\u751f\u547d\u5468\u671f\uff0c\u5982 didMount\n        \n        // commitUpdateQueue ...\n      }\n      case HostRoot: {\n        // commitUpdateQueue ... \u904d\u5386\u8c03\u7528 finishedWork.updateQueue.effects \u7684 callback\n      }\n      case HostComponent: {\n        // \u6e32\u67d3\u5668\u53ef\u4ee5\u5728\u6302\u5728host component \u540e\u5b89\u6392\u8981\u5b8c\u6210\u7684\u5de5\u4f5c\uff08\u4f8b\u5982\u53ef\u4ee5\u5b89\u6392\u8f93\u5165\u548c\u8868\u5355\u63a7\u4ef6\u7684\u81ea\u52a8\u805a\u7126\uff09\n        // \u53ea\u6709\u5728\u9996\u6b21\u6302\u5728\u65f6\u624d\u4f1a\u5904\u7406\n        if (current === null && finishedWork.flags & Update) {\n          // commitMount ... focus \u5904\u7406\n        }\n      }\n    }\n  }\n}\n")))}d.isMDXComponent=!0}}]);