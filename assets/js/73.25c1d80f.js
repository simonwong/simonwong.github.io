(window.webpackJsonp=window.webpackJsonp||[]).push([[73],{382:function(t,s,a){"use strict";a.r(s);var n=a(27),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"nginx配置https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx配置https"}},[t._v("#")]),t._v(" nginx配置https")]),t._v(" "),a("h2",{attrs:{id:"安装-nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-nginx"}},[t._v("#")]),t._v(" 安装 nginx")]),t._v(" "),a("p",[t._v("有可能你当前已经通过 "),a("code",[t._v("apt-get")]),t._v(" "),a("code",[t._v("yum")]),t._v(" 等命令安装了，但是可能不支持 https http2 ipv6 等功能。")]),t._v(" "),a("h3",{attrs:{id:"查看当前版本配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看当前版本配置"}},[t._v("#")]),t._v(" 查看当前版本配置")]),t._v(" "),a("p",[t._v("我们可以通过 "),a("code",[t._v("nginx -V")]),t._v(" 命令来查看版本以及支持的配置。")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://file.wangsijie.top/blog/20200203093550.png",alt:""}})]),t._v(" "),a("p",[t._v("下面这以 ubuntu 为例，卸载安装 nginx")]),t._v(" "),a("h3",{attrs:{id:"卸载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#卸载"}},[t._v("#")]),t._v(" 卸载")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 移除 nginx")]),t._v("\n$ apt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("get "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("purge remove nginx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查询 nginx 依赖的包，会列出来")]),t._v("\n$ dpkg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get-selections")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v("grep nginx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 移除上面列出的包，例如 nginx-common")]),t._v("\n$ apt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("get "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("purge remove nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("common\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 也可以执行 autoremove ，会自动删除不需要的包")]),t._v("\n$ apt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("get autoremove\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查询 nginx 相关的文件，删掉就可以了")]),t._v("\n$ sudo find "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("name nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("\n\n")])])]),a("h3",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[t._v("#")]),t._v(" 安装")]),t._v(" "),a("p",[t._v("安装依赖库")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# gcc g++")]),t._v("\napt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("get install build"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("essential\napt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("get install libtool\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pcre")]),t._v("\nsudo apt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("get install libpcre3 libpcre3"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("dev\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# zlib")]),t._v("\napt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("get install zlib1g"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("dev\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ssl")]),t._v("\napt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("get install openssl\napt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("get install libssl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("dev\n")])])]),a("p",[t._v("安装 nginx")]),t._v(" "),a("p",[t._v("到 "),a("a",{attrs:{href:"https://nginx.org/en/download.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("nginx download"),a("OutboundLink")],1),t._v(" 上找到最新的nginx 版本")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下载")]),t._v("\n$ wget https:"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("org"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("download"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("17"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tar"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("gz\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 解压")]),t._v("\n$ tar "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("zxvf nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("17"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tar"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("gz\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进入目录")]),t._v("\n$ cd nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("17"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("8\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置，这里可能会报错，缺少啥就去安装啥")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("configure "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("prefix="),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx \\\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("with"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("http_gzip_static_module \\\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("with"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("http_v2_module \\\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("with"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("pcre \\\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("with"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("http_ssl_module\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 编译，这里可能会报错，缺少啥就去安装啥")]),t._v("\n$ make\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装")]),t._v("\n$ make install\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 通过软连接，这样就可以直接使用 nginx 执行")]),t._v("\n$ sudo ln "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("sbin"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("bin"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx\n")])])]),a("h2",{attrs:{id:"ssl-证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssl-证书"}},[t._v("#")]),t._v(" SSL 证书")]),t._v(" "),a("p",[t._v("SSL 证书通常需要购买，也有免费的，通过第三方 SSL 证书机构颁发。你也可以在云服务商上购买，但是一般免费的 ssl 证书只能支持单个域名。")]),t._v(" "),a("p",[t._v("这里推荐 "),a("a",{attrs:{href:"https://letsencrypt.org/zh-cn/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Let’s Encrypt"),a("OutboundLink")],1),t._v(" 机构，然后使用 "),a("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh",target:"_blank",rel:"noopener noreferrer"}},[t._v("acme.sh"),a("OutboundLink")],1),t._v(" 从 letsencrypt 生成免费的证书，且可以生成泛域名证书。")]),t._v(" "),a("p",[t._v("参考 "),a("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E",target:"_blank",rel:"noopener noreferrer"}},[t._v("acme.sh 中文 wiki"),a("OutboundLink")],1),t._v(" 、"),a("a",{attrs:{href:"https://f-e-d.club/topic/use-acme-sh-deployment-let-s-encrypt-by-ali-cloud-dns-generic-domain-https-authentication.article",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用 acme.sh 部署 Let's Encrypt 通过阿里云 DNS 验证方式实现泛域名 HTTPS"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("上面的两篇文章讲的很详细了，不再赘述。")]),t._v(" "),a("p",[t._v("PS：")]),t._v(" "),a("ul",[a("li",[t._v("建议使用 DNS 验证")]),t._v(" "),a("li",[a("code",[t._v("--dns dns_ali")]),t._v("  是根据不同服务商来的，"),a("code",[t._v("dns_ali")]),t._v(" 就是指阿里云。其他服务商的参考 "),a("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/wiki/dnsapi",target:"_blank",rel:"noopener noreferrer"}},[t._v("How to use DNS API"),a("OutboundLink")],1),t._v(" 。")]),t._v(" "),a("li",[t._v("证书生成后，默认在 "),a("code",[t._v("~/.acme.sh/")]),t._v(" 目录下，这里的文件是内部使用的，需要使用 "),a("code",[t._v("--installcert")]),t._v(" 命令指定到目标位置")])]),t._v(" "),a("p",[t._v("这里将证书放到了 nginx 的 conf 目录下。"),a("code",[t._v(".../conf/ssl/...")])]),t._v(" "),a("h2",{attrs:{id:"配置-http"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-http"}},[t._v("#")]),t._v(" 配置 http")]),t._v(" "),a("h3",{attrs:{id:"http-基础配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-基础配置"}},[t._v("#")]),t._v(" http 基础配置")]),t._v(" "),a("p",[t._v("http 的配置很简单，配置如下，我们先让网站可以访问起来。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("     wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top www"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("使用 "),a("code",[t._v("http://")]),t._v("访问，就会如下显示")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://file.wangsijie.top/blog/20200202134046.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"配置-https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-https"}},[t._v("#")]),t._v(" 配置 https")]),t._v(" "),a("h3",{attrs:{id:"https-基础配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#https-基础配置"}},[t._v("#")]),t._v(" Https 基础配置")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("             wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top www"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 证书文件，这里使用了 fullchain.cer 通过 acme.sh 生成的泛域名证书")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("fullchain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 私钥文件")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate_key")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("重启后，以 "),a("code",[t._v("https://")]),t._v(" 开头访问你的网站，就会发现")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://file.wangsijie.top/blog/20200202135322.png",alt:""}})]),t._v(" "),a("p",[a("img",{attrs:{src:"http://file.wangsijie.top/blog/20200202135347.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"修改-http-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改-http-配置"}},[t._v("#")]),t._v(" 修改 http 配置")]),t._v(" "),a("p",[t._v("但是用 "),a("code",[t._v("http://")]),t._v(" 访问，仍旧显示连接不安全，我们需要修改配置，当访问 http 时会重定向到 https 如下")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("     wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top www"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("301")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("https")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$server_name")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$request_uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("这时再用 "),a("code",[t._v("http://")]),t._v(" 访问，就会重定向到 "),a("code",[t._v("https://")])]),t._v(" "),a("p",[t._v("PS:")]),t._v(" "),a("p",[t._v("网上也有许多使用 "),a("code",[t._v("rewrite")]),t._v(" 来重定向，但是 "),a("code",[t._v("return")]),t._v(" 指令简单高效，建议尽量使用 "),a("code",[t._v("return")])]),t._v(" "),a("h3",{attrs:{id:"完整配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#完整配置"}},[t._v("#")]),t._v(" 完整配置")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("     wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top www"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("301")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("https")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$server_name")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$request_uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("             wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top www"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("fullchain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate_key")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"混合配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#混合配置"}},[t._v("#")]),t._v(" 混合配置")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("  \t\t\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("             wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top www"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("fullchain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate_key")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"https-安全"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#https-安全"}},[t._v("#")]),t._v(" https 安全")]),t._v(" "),a("h3",{attrs:{id:"加密套件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加密套件"}},[t._v("#")]),t._v(" 加密套件")]),t._v(" "),a("p",[t._v("https 默认采用 SHA-1 算法，非常脆弱。我们可以使用 "),a("a",{attrs:{href:"https://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E5%AF%86%E9%91%B0%E4%BA%A4%E6%8F%9B",target:"_blank",rel:"noopener noreferrer"}},[t._v("迪菲-赫尔曼密钥交换"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("我们在 "),a("code",[t._v("/conf/ssl")]),t._v(" 目录下生成 "),a("code",[t._v("dhparam.pem")]),t._v(" 文件")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[t._v("openssl dhparam "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("out dhparam"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pem 2048\n")])])]),a("p",[t._v("下面的指令 "),a("code",[t._v("ssl_protocols")]),t._v(" 和 "),a("code",[t._v("ssl_ciphers")]),t._v(" 是用来限制连接只包含 SSL/TLS 的加強版本和算法。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 优先采取服务器算法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_prefer_server_ciphers")]),t._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用 DH 文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_dhparam")]),t._v(" \t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("dhparam"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 协议版本")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_protocols")]),t._v("           TLSv1 TLSv1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" TLSv1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 定义算法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_ciphers")]),t._v("\t\t\tEECDH"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("CHACHA20"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("EECDH"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("AES128"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("RSA"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("AES128"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("EECDH"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("AES256"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("RSA"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("AES256"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("EECDH"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("DES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("RSA"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("DES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("MD5"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"安全的响应头"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安全的响应头"}},[t._v("#")]),t._v(" 安全的响应头")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启用 HSTS 。允许 https 网站要求浏览器总是通过 https 来访问")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Strict"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Transport"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Security "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-age=31536000; includeSubDomains;preload"')]),t._v(" always"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 减少点击劫持")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" X"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Frame"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Options "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DENY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 禁止服务器自动解析资源类型")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" X"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Content"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Options nosniff"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 防XSS攻擊")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" X"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Xss"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Protection "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"服务器优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务器优化"}},[t._v("#")]),t._v(" 服务器优化")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置共享会话缓存大小")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_session_cache")]),t._v("   shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SSL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置会话超时时间")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_session_timeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"http2-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http2-配置"}},[t._v("#")]),t._v(" http2 配置")]),t._v(" "),a("p",[t._v("http2 配置很简单，只要后面增加 http2。")]),t._v(" "),a("p",[t._v("下面 "),a("code",[t._v("[::]:")]),t._v(" 表示 ipv6 的配置，不需要可以不加那一行")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),t._v(" http2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),t._v(" http2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("重启 nginx 后，你可以在这个网站上 https://tools.keycdn.com/http2-test 测试http2有没有配置成功。")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://file.wangsijie.top/blog/20200202223844.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"最后"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#最后"}},[t._v("#")]),t._v(" 最后")]),t._v(" "),a("h3",{attrs:{id:"完整配置-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#完整配置-2"}},[t._v("#")]),t._v(" 完整配置")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),t._v(" http2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),t._v(" http2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("             wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top www"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("fullchain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate_key")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_session_cache")]),t._v("       shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SSL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_session_timeout")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_prefer_server_ciphers")]),t._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_dhparam")]),t._v(" \t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("dhparam"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_protocols")]),t._v("           TLSv1 TLSv1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" TLSv1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_ciphers")]),t._v("     EECDH"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("CHACHA20"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("EECDH"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("AES128"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("RSA"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("AES128"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("EECDH"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("AES256"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("RSA"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("AES256"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("EECDH"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("DES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("RSA"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("DES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("MD5"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Strict"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Transport"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Security "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-age=31536000; includeSubDomains; preload"')]),t._v(" always"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" X"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Frame"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Options "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DENY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" X"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Content"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Options nosniff"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" X"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Xss"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Protection "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"配置文件优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置文件优化"}},[t._v("#")]),t._v(" 配置文件优化")]),t._v(" "),a("p",[t._v("为了让更多的二级域名支持上面的功能，每个 server 都这么写太过于繁琐。")]),t._v(" "),a("p",[t._v("可以将 listen 443 、ssl、add_header 相关的单独写在一个文件上，然后使用 "),a("code",[t._v("inculde")]),t._v(" 指令。")]),t._v(" "),a("p",[t._v("如下：其他的配置都放在了"),a("code",[t._v("conf.d/https-base.conf")]),t._v("中")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8099")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8099")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("             test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wangsijie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v("                 conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("d"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("https")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("base"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("以上就完成了 https 的配置，愉快的访问你的网站吧。")]),t._v(" "),a("h2",{attrs:{id:"参考链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[t._v("#")]),t._v(" 参考链接")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.kancloud.cn/wizardforcel/nginx-doc/92353",target:"_blank",rel:"noopener noreferrer"}},[t._v("Nginx 中文文档"),a("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);