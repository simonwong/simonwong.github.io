(window.webpackJsonp=window.webpackJsonp||[]).push([[81],{399:function(t,a,s){"use strict";s.r(a);var n=s(27),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"npm多版本包依赖问题探讨"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#npm多版本包依赖问题探讨"}},[t._v("#")]),t._v(" npm多版本包依赖问题探讨")]),t._v(" "),s("p",[t._v("最近在思考这样一个问题，当项目依赖了多个不同版本的包，打包结果和 node_modules 依赖结构会有什么不一样？会不会高版本的覆盖低版本的方法呢？如果覆盖了就可能导致程序 bug 。")]),t._v(" "),s("p",[t._v("为了尝试多版本依赖问题，我写了两个包来测试，已经放在了 npm 上。分别是 "),s("a",{attrs:{href:"https://www.npmjs.com/package/@flypkg/main",target:"_blank",rel:"noopener noreferrer"}},[t._v("@flypkg/main"),s("OutboundLink")],1),t._v(" "),s("a",{attrs:{href:"https://www.npmjs.com/package/@flypkg/suba",target:"_blank",rel:"noopener noreferrer"}},[t._v("@flypkg/suba"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("仓库地址是 https://github.com/simonwong/flypkg")]),t._v(" "),s("h2",{attrs:{id:"验证思路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#验证思路"}},[t._v("#")]),t._v(" 验证思路")]),t._v(" "),s("p",[t._v("验证思路是这样的")]),t._v(" "),s("p",[s("code",[t._v("suba")]),t._v(" 包暴露了一个 "),s("code",[t._v("runSubA")]),t._v(" 方法，会打印出自己当前版本。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("runSubA")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("logMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'subA'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pkg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("version"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'在 subA 中执行'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("code",[t._v("main")]),t._v(" 包依赖与自己相同版本的 "),s("code",[t._v("suba")]),t._v(" 并暴露一个 "),s("code",[t._v("init")]),t._v(" 放执行 "),s("code",[t._v("runSubA")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("logMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'main'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pkg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("version"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'在 main 中执行'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("runSubA")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("然后在项目中依赖不同版本的 @flypkg/main 和 @flypkg/suba ，并同时执行 "),s("code",[t._v("init")]),t._v("  和 "),s("code",[t._v("runSubA")]),t._v(" 方法")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" init "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@flypkg/main'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" runSubA "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@flypkg/suba'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("runSubA")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"http://file.wangsijie.top/blog/20200510214555.png",alt:""}})]),t._v(" "),s("p",[t._v("可能不同版本的 yarn 和 npm 会有不同的结果，这里的测试版本为 "),s("code",[t._v("yarn@1.22.0")]),t._v(" "),s("code",[t._v("npm@6.14.4")])]),t._v(" "),s("h2",{attrs:{id:"尝试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#尝试"}},[t._v("#")]),t._v(" 尝试")]),t._v(" "),s("h3",{attrs:{id:"第一次尝试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第一次尝试"}},[t._v("#")]),t._v(" 第一次尝试")]),t._v(" "),s("p",[t._v("我们的 package.json 的版本是这样的。注意：这里的 suba 版本没有加 "),s("code",[t._v("^")])]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"dependencies"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@flypkg/main"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"^0.0.2"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@flypkg/suba"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),s("p",[t._v("执行 "),s("code",[t._v("yarn list")]),t._v(" 是这样的")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("├─ @flypkg/main@0.0.2\n│  ├─ @flypkg/suba@^0.0.2\n│  └─ @flypkg/suba@0.0.2\n├─ @flypkg/suba@0.0.1\n")])])]),s("p",[t._v("输出结果如下")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://file.wangsijie.top/blog/20200510220431.png",alt:""}})]),t._v(" "),s("p",[t._v("看了下 webpack 的打包结果，存在两个 "),s("code",[t._v("runSubA")]),t._v(" 方法，在各自的执行代码块中，对应 0.0.1 和 0.0.2 版本。")]),t._v(" "),s("h3",{attrs:{id:"第二次尝试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第二次尝试"}},[t._v("#")]),t._v(" 第二次尝试")]),t._v(" "),s("p",[t._v("考虑到是否因为 "),s("code",[t._v("^")]),t._v(" 符号影响，我在 suba 包前面加了 "),s("code",[t._v("^")]),t._v(" 符号。 "),s("code",[t._v("^")]),t._v(" 的加入，可以使 install 的时候安装到 "),s("code",[t._v("0.x.x")]),t._v(" 的最新版本。")]),t._v(" "),s("p",[t._v("然而实际的依赖树和执行结果同上。")]),t._v(" "),s("h3",{attrs:{id:"第三次尝试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第三次尝试"}},[t._v("#")]),t._v(" 第三次尝试")]),t._v(" "),s("p",[t._v("修改 package.json 如下")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"dependencies"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@flypkg/main"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"^0.0.2"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"@flypkg/suba"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"^0.0.3"')]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),s("p",[s("code",[t._v("yarn list")]),t._v(" 结果如下")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("├─ @flypkg/main@0.0.2\n│  ├─ @flypkg/suba@^0.0.2\n│  └─ @flypkg/suba@0.0.2\n├─ @flypkg/suba@0.0.3\n")])])]),s("p",[t._v("执行结果如下")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://file.wangsijie.top/blog/20200510223557.png",alt:""}})]),t._v(" "),s("p",[t._v("依旧是执行不同的依赖版本的方法。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("嗯～～～对结果表示心满意足。这样就避免了一开始我所担心的问题。我们可以继续放心的在项目中使用新的依赖了。(≧▽≦)/")]),t._v(" "),s("p",[t._v("等等，我们是不是忽略了什么问题。")]),t._v(" "),s("h3",{attrs:{id:"问题一"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题一"}},[t._v("#")]),t._v(" 问题一")]),t._v(" "),s("p",[t._v("由于存在各种版本的方法，我们最终打包的体积也变的更大了！是的，我们只能眼睁着包的体积变大。")]),t._v(" "),s("p",[t._v("有什么优化手段呢？")]),t._v(" "),s("p",[t._v("就是尽可能的使用 ES Module 规范和支持 tree shaking 的包，就是在包的 package.json 中，写着这样的一行代码 "),s("code",[t._v('"sideEffects": false')]),t._v(" 。")]),t._v(" "),s("p",[t._v("它来告诉 "),s("code",[t._v("webpack")]),t._v(" ，如果我这个包有些方法没有被使用，那么你可以尽情的抖掉（不打包）。避免代码冗余。")]),t._v(" "),s("h3",{attrs:{id:"问题二"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题二"}},[t._v("#")]),t._v(" 问题二")]),t._v(" "),s("p",[t._v("如果 "),s("code",[t._v("main@0.0.3")]),t._v(" 依赖的 "),s("code",[t._v("suba@0.0.3")]),t._v(" 存在着 bug ，我们该怎么解决呢。")]),t._v(" "),s("p",[t._v("使用 "),s("code",[t._v("resolutions")]),t._v(" 强行锁版本。yarn 支持，npm 需要使用 "),s("code",[t._v("npm-froce-resolution")]),t._v(" 这个库来实现。")]),t._v(" "),s("div",{staticClass:"language-package.json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('/* package.json */\n{\n\t"resolutions": {\n\t\t"@flypkg/suba": "0.0.2"\n\t}\n}\n')])])]),s("p",[t._v("相关阅读 "),s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/137535779",target:"_blank",rel:"noopener noreferrer"}},[t._v("node_modules 困境"),s("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);