(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{415:function(_,v,t){"use strict";t.r(v);var e=t(27),a=Object(e.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h1",{attrs:{id:"tcp协议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tcp协议"}},[_._v("#")]),_._v(" TCP协议")]),_._v(" "),t("p",[_._v("网络协议分层：")]),_._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[_._v("应用层（HTTP、DNS、DHCP...)\n传输层（UDP协议、TCP协议）\n网络层（IP协议）\n链路层（以太网协议，依靠mac地址）\n物理层（网线，光线...010101）\n")])])]),t("p",[t("img",{attrs:{src:"http://file.wangsijie.top/share/tcp/bg2017060804.png",alt:""}})]),_._v(" "),t("ul",[t("li",[_._v("以太网协议(Ethernet)规定电子信号如何组成数据包，解决子网内部的点对点通信")]),_._v(" "),t("li",[_._v("IP协议定义了一套地址规则，可以连接多个局域网")])]),_._v(" "),t("p",[_._v("但是IP协议并不保证数据包的完整。如果丢包了，就需要TCP协议来发现丢了那个包，重新发送这个包")]),_._v(" "),t("h2",{attrs:{id:"数据包大小"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据包大小"}},[_._v("#")]),_._v(" 数据包大小")]),_._v(" "),t("p",[t("img",{attrs:{src:"http://file.wangsijie.top/share/tcp/bg2012052913.png",alt:""}})]),_._v(" "),t("p",[_._v("以太网数据包负载是1500字节，TCP数据包的负载在1400字节左右")]),_._v(" "),t("h2",{attrs:{id:"数据包拆分编号"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据包拆分编号"}},[_._v("#")]),_._v(" 数据包拆分编号")]),_._v(" "),t("blockquote",[t("p",[_._v("一次性发送大量数据，必须拆分成多个包。比如10MB的文件需要发送7100多个包")])]),_._v(" "),t("ul",[t("li",[_._v("发送的时候，TCP协议给每个包编号")]),_._v(" "),t("li",[_._v("第一个包编号是个随机数，假设是1号包，他的负载长度为100字节，那么下一个包的编号为101")]),_._v(" "),t("li",[_._v("每一个包都可以得到自身编号，以及自身编号加上自身负载长度得到下一个包的编号")])]),_._v(" "),t("h2",{attrs:{id:"数据包组装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据包组装"}},[_._v("#")]),_._v(" 数据包组装")]),_._v(" "),t("blockquote",[t("p",[_._v("收到TCP数据包之后，组装还原是"),t("strong",[_._v("操作系统")]),_._v("完成的。按照上面拆分的顺序去组装")]),_._v(" "),t("p",[_._v("TCP数据包有一个端口参数，用来指定转交给监听该端口的应用程序")])]),_._v(" "),t("p",[_._v("TCP没有机制表示原始文件的大小，这个由应用层的协议来规定。")]),_._v(" "),t("p",[_._v("比如")]),_._v(" "),t("ul",[t("li",[_._v("HTTP协议的头信息"),t("code",[_._v("Content-Type")]),_._v("，用来表示信息的大小。")]),_._v(" "),t("li",[_._v("浏览器根据"),t("code",[_._v("Content-Type")]),_._v("字段读出一段段的数据。")]),_._v(" "),t("li",[_._v("那么，一次TCP通信，可以包含多个HTTP通信")])]),_._v(" "),t("h2",{attrs:{id:"慢启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#慢启动"}},[_._v("#")]),_._v(" 慢启动")]),_._v(" "),t("p",[_._v("为了做到效率与可靠性的统一，设计了慢启动的机制。")]),_._v(" "),t("p",[_._v("一开始发送慢，不丢包就加速，丢包就降速.")]),_._v(" "),t("p",[_._v("不论带宽多好，都从10个数据包开始试，然后达到最高速率")]),_._v(" "),t("h2",{attrs:{id:"tcp标志位"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tcp标志位"}},[_._v("#")]),_._v(" TCP标志位")]),_._v(" "),t("p",[_._v("SYN -- synchronous 建立联机")]),_._v(" "),t("p",[_._v("ACK -- acknowledgment 确认序号有效")]),_._v(" "),t("p",[_._v("PSH -- push 传送，接收方将报文交给应用层")]),_._v(" "),t("p",[_._v("FIN -- finish 结束，释放连接")]),_._v(" "),t("p",[_._v("RST -- reset 重置连接")]),_._v(" "),t("p",[_._v("URG -- urgent 紧急指针")]),_._v(" "),t("hr"),_._v(" "),t("p",[_._v("Sequence number -- 顺序号码")]),_._v(" "),t("p",[_._v("Acknowledge number -- 确认号码")]),_._v(" "),t("h2",{attrs:{id:"ack"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ack"}},[_._v("#")]),_._v(" ACK")]),_._v(" "),t("p",[_._v("接收方没收到两个TCP数据包，就要发送一个确认（acknowledgement）消息")]),_._v(" "),t("p",[_._v("ACK携带两个信息")]),_._v(" "),t("blockquote",[t("p",[_._v("期待要收到下一个数据包的编号")]),_._v(" "),t("p",[_._v("接收方的接收窗口的剩余容量")])]),_._v(" "),t("p",[t("img",{attrs:{src:"http://file.wangsijie.top/share/tcp/bg2017060809.png",alt:""}})]),_._v(" "),t("blockquote",[t("p",[_._v("实际上TCP的通信是双向的，双方都需要发送ACK")])]),_._v(" "),t("p",[t("img",{attrs:{src:"http://file.wangsijie.top/share/tcp/bg2017060812.jpg",alt:""}})]),_._v(" "),t("blockquote",[t("p",[_._v("不要被这个图片误导，双方的第一次给数据包，他们的seq都是随机生成的。")])]),_._v(" "),t("p",[_._v("对于单向来说：")]),_._v(" "),t("p",[_._v("第一次: Seq=1; length=100；Ack=1")]),_._v(" "),t("p",[_._v("第二次：Seq=100+1； length= 50；Ack=对方第一次返回的Seq+length")]),_._v(" "),t("p",[_._v("第三次：Seq=101+50； length=200；Ack=对方第二次返回的Seq+length")]),_._v(" "),t("h2",{attrs:{id:"数据包遗失处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据包遗失处理"}},[_._v("#")]),_._v(" 数据包遗失处理")]),_._v(" "),t("p",[_._v("如果下一个数据包没有收到，那么ACK的编号就不会变")]),_._v(" "),t("p",[_._v("如果发送方收到了3个连续的重复ACK，或者超时收到ACK，就会确认这个包丢了，重新发送")]),_._v(" "),t("p",[t("img",{attrs:{src:"http://file.wangsijie.top/share/tcp/bg2017060811.png",alt:""}})]),_._v(" "),t("p",[_._v("这里关于2号包重发后，3、4、5号包是否重发，涉及到TCP的版本。")]),_._v(" "),t("p",[_._v("现阶段的是，3、4、5号包不会重发。接收到2号包后，将会返回5号包后的ack，然后接着发6号包。")]),_._v(" "),t("h2",{attrs:{id:"三次握手"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三次握手"}},[_._v("#")]),_._v(" 三次握手")]),_._v(" "),t("h3",{attrs:{id:"目的"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#目的"}},[_._v("#")]),_._v(" 目的")]),_._v(" "),t("blockquote",[t("p",[_._v("同步连接双方的序列号和确认号并交换 TCP 窗口大小信息。")])]),_._v(" "),t("h3",{attrs:{id:"直白理解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#直白理解"}},[_._v("#")]),_._v(" 直白理解")]),_._v(" "),t("blockquote",[t("p",[_._v("A > B：我要对你讲话，你能听到么")]),_._v(" "),t("p",[_._v("B > A：我能，我也要对你讲话，你能听到么")]),_._v(" "),t("p",[_._v("A > B：我也能")])]),_._v(" "),t("h3",{attrs:{id:"状态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#状态"}},[_._v("#")]),_._v(" 状态")]),_._v(" "),t("blockquote",[t("p",[_._v("SYN_SEND")]),_._v(" "),t("p",[_._v("SYN_RECV")]),_._v(" "),t("p",[_._v("ESTABLISHED")])]),_._v(" "),t("h3",{attrs:{id:"理解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#理解"}},[_._v("#")]),_._v(" 理解")]),_._v(" "),t("p",[t("img",{attrs:{src:"http://file.wangsijie.top/share/tcp/221638042536625.png",alt:""}})]),_._v(" "),t("ul",[t("li",[_._v("第一次握手：主机A发送位码"),t("code",[_._v("SYN=1")]),_._v("，随机生成"),t("code",[_._v("seq number=x")]),_._v("，将这个数据包发送给主机B")]),_._v(" "),t("li",[_._v("第二次握手：主机B收到"),t("code",[_._v("SYN=1")]),_._v("，确认了联机信息，发送"),t("code",[_._v("ack number = x+1")]),_._v("，"),t("code",[_._v("SYN=1")]),_._v("，"),t("code",[_._v("ACK=1")]),_._v("，随机生成"),t("code",[_._v("seq number=y")]),_._v("。此时主机A进入ESTABLISHED已确认状态")]),_._v(" "),t("li",[_._v("第三次握手：主机A收到信息，确认主机B的"),t("code",[_._v("ack number =? seq number+1")]),_._v("，且"),t("code",[_._v("ACK =? 1")]),_._v("。就在发送"),t("code",[_._v("ack number = y+1")]),_._v(" "),t("code",[_._v("ACK = 1")]),_._v(" "),t("code",[_._v("seq number = x+1")]),_._v("。此时主机B进入ESTABLISHED状态")])]),_._v(" "),t("h3",{attrs:{id:"例子"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[_._v("#")]),_._v(" 例子")]),_._v(" "),t("p",[_._v("IP 192.168.1.116.3337 > 192.168.1.123.7788: S 3626544836:3626544836\nIP 192.168.1.123.7788 > 192.168.1.116.3337: S 1739326486:1739326486 ack 3626544837\nIP 192.168.1.116.3337 > 192.168.1.123.7788: ack 1739326487,ack 1")]),_._v(" "),t("h3",{attrs:{id:"ddos攻击-syn-flood攻击"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ddos攻击-syn-flood攻击"}},[_._v("#")]),_._v(" DDOS攻击 - SYN Flood攻击")]),_._v(" "),t("p",[_._v("伪造大量不存在的IP，向服务器发送SYN包，服务器回复确认包，进入SYN_RECV状态。（此时TCP连接为半连接状态half-open- connect）")]),_._v(" "),t("p",[_._v("由于源地址不存在，服务器会不断的重发包直到超时。一直占用队列。")]),_._v(" "),t("h2",{attrs:{id:"四次挥手"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四次挥手"}},[_._v("#")]),_._v(" 四次挥手")]),_._v(" "),t("blockquote",[t("p",[_._v("因为TCP连接是双全工的，每一方都要单独关闭。")]),_._v(" "),t("p",[_._v("一方发送FIN，终止连接，不再传送数据，另一方可以继续发送数据，直到他也发送FIN")])]),_._v(" "),t("h3",{attrs:{id:"理解-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#理解-2"}},[_._v("#")]),_._v(" 理解")]),_._v(" "),t("p",[t("img",{attrs:{src:"http://file.wangsijie.top/share/tcp/221638047387940.jpg",alt:""}})]),_._v(" "),t("ul",[t("li",[_._v("第一次挥手：主机A发送"),t("code",[_._v("FIN=1")]),_._v(" "),t("code",[_._v("seq number=x")]),_._v("。主机A进入 FIN_WAIT_1状态")]),_._v(" "),t("li",[_._v("第二次挥手：主机B收到"),t("code",[_._v("FIN=1")]),_._v(" ，返回确认包"),t("code",[_._v("ACK=1")]),_._v(" "),t("code",[_._v("ack number = x + 1")]),_._v(" "),t("code",[_._v("seq number=y")]),_._v(" 。主机B进入CLOSE_WAIT状态。主机A进入FIN_WAIT_1状态。")]),_._v(" "),t("li",[_._v("第三次挥手：主机B发送"),t("code",[_._v("FIN=1")]),_._v(" "),t("code",[_._v("ACK=1")]),_._v(" "),t("code",[_._v("seq number = z")]),_._v(" "),t("code",[_._v("ack number = x + 1")]),_._v("。主机B进入LAST_ACK状态")]),_._v(" "),t("li",[_._v("第四次挥手：主机A收到"),t("code",[_._v("FIN=1")]),_._v("，发送了"),t("code",[_._v("ACK=1")]),_._v(" "),t("code",[_._v("seq number = x+1")]),_._v(" "),t("code",[_._v("ack number = z + 1")]),_._v("，立刻进入TIME_WAIT状态，等带2MSL进入CLOSED状态。主机B收到立即进入CLOSED状态。")])]),_._v(" "),t("h3",{attrs:{id:"为什么是四次挥手"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么是四次挥手"}},[_._v("#")]),_._v(" 为什么是四次挥手")]),_._v(" "),t("p",[_._v("收到FIN时，表示对方不再发送数据了，但还可以接收数据。自己这边，可能还有部分数据没有给玩。")]),_._v(" "),t("p",[_._v("由于ACK报文，和FIN报文基本都是分开发的")]),_._v(" "),t("p",[_._v("第二次挥手给ACK")]),_._v(" "),t("p",[_._v("第三次挥手给FIN + ACK")])])}),[],!1,null,null,null);v.default=a.exports}}]);